<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:20px}
    h1{margin-bottom:8px}
    section{margin-bottom:24px;padding:16px;border:1px solid #ddd;border-radius:8px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #eee;padding:8px;text-align:left}
    label{display:block;margin:6px 0}
    input,select{padding:6px;width:100%;max-width:320px}
    button{padding:8px 12px;margin-top:8px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .row > div{flex:1 1 320px}
    .muted{color:#b3b3b3;font-size:12px}
    .error{color:#b00020}
    .success{color:#087f23}
    .nav{display:flex;gap:12px;margin:12px 0 20px}
    .nav a{padding:8px 12px;border-radius:6px;text-decoration:none;color:#333;border:1px solid #ddd}
    .nav a.active{background:#f5f5f5;border-color:#bbb}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal{background:#fff;border-radius:8px;padding:16px;width:90%;max-width:640px;box-shadow:0 10px 30px rgba(0,0,0,0.2)}
    [x-cloak]{display:none !important}
  </style>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="min-h-screen bg-gray-900 text-gray-100">
  <div x-data="admin()" x-init="load()" class="w-4/5 mx-auto p-6 min-h-screen">
    <h1>Admin Panel</h1>
    <p class="muted">Manage records and orders.</p>
    <nav class="flex gap-3 mt-8 mb-8">
      <a href="#" class="px-3 py-2 rounded-md border border-gray-700 text-gray-200 hover:bg-gray-800" :class="page==='dashboard' ? 'bg-gray-800 border-gray-600' : ''" @click.prevent="page='dashboard'">Dashboard</a>
      <a href="#" class="px-3 py-2 rounded-md border border-gray-700 text-gray-200 hover:bg-gray-800" :class="page==='records' ? 'bg-gray-800 border-gray-600' : ''" @click.prevent="page='records'">Records</a>
      <a href="#" class="px-3 py-2 rounded-md border border-gray-700 text-gray-200 hover:bg-gray-800" :class="page==='create' ? 'bg-gray-800 border-gray-600' : ''" @click.prevent="page='create'">Create Record</a>
      <a href="#" class="px-3 py-2 rounded-md border border-gray-700 text-gray-200 hover:bg-gray-800" :class="page==='orders' ? 'bg-gray-800 border-gray-600' : ''" @click.prevent="page='orders'">Orders</a>
    </nav>

    <section x-show="page==='dashboard'" class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
      <h2>Dashboard</h2>
      <div class="row">
        <div>
          <div>Records loaded: <span x-text="records.length"></span></div>
          <div>Last loaded: <span x-text="lastLoaded"></span></div>
          <button @click="load()">Reload</button>
        </div>
      </div>
    </section>

    <section x-show="page==='records'" class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
      <h2>Records</h2>
      <div class="row">
        <div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <label class="block text-sm font-medium">Search<input class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100 placeholder-gray-400" type="text" x-model="search" placeholder="Beatles, Abbey Road..."></label>
            <label class="block text-sm font-medium">Format
              <select class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" x-model="formatFilter">
                <option value="">Any</option>
                <option>Vinyl</option>
                <option>CD</option>
                <option>Cassette</option>
                <option>Digital</option>
              </select>
            </label>
            <label class="block text-sm font-medium">Category
              <select class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" x-model="categoryFilter">
                <option value="">Any</option>
                <option>Rock</option>
                <option>Jazz</option>
                <option>Hip-Hop</option>
                <option>Classical</option>
                <option>Pop</option>
                <option>Alternative</option>
                <option>Indie</option>
              </select>
            </label>
            <label class="block text-sm font-medium">Sort
              <select class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" x-model="sortParam">
                <option value="created">Created</option>
                <option value="price">Price</option>
                <option value="relevance">Relevance</option>
              </select>
            </label>
          </div>
          <div class="text-gray-400 text-sm" x-text="loading ? 'Loading records...' : ('Page ' + currentPage + ' of ' + totalPages + ' â€¢ ' + records.length + ' items loaded')"></div>
          <table class="min-w-full text-sm border border-gray-700 rounded-lg overflow-hidden mt-3 bg-gray-900">
            <thead>
              <tr>
                <th class="border-b border-gray-700 bg-gray-800 px-3 py-2 text-left">Id</th><th class="border-b border-gray-700 bg-gray-800 px-3 py-2 text-left">Artist</th><th class="border-b border-gray-700 bg-gray-800 px-3 py-2 text-left">Album</th><th class="border-b border-gray-700 bg-gray-800 px-3 py-2 text-left">Price</th><th class="border-b border-gray-700 bg-gray-800 px-3 py-2 text-left">Qty</th><th class="border-b border-gray-700 bg-gray-800 px-3 py-2 text-left">Format</th><th class="border-b border-gray-700 bg-gray-800 px-3 py-2 text-left">Category</th><th class="border-b border-gray-700 bg-gray-800 px-3 py-2 text-left">MBID</th><th class="border-b border-gray-700 bg-gray-800 px-3 py-2 text-left">Actions</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="r in records" :key="r.id">
                <tr>
                  <td class="border-t border-gray-700 px-3 py-2" x-text="r.id"></td>
                  <td class="border-t border-gray-700 px-3 py-2" x-text="r.artist"></td>
                  <td class="border-t border-gray-700 px-3 py-2" x-text="r.album"></td>
                  <td class="border-t border-gray-700 px-3 py-2" x-text="r.price"></td>
                  <td class="border-t border-gray-700 px-3 py-2" x-text="r.qty"></td>
                  <td class="border-t border-gray-700 px-3 py-2" x-text="r.format"></td>
                  <td class="border-t border-gray-700 px-3 py-2" x-text="r.category"></td>
                  <td class="border-t border-gray-700 px-3 py-2" x-text="r.mbid"></td>
                  <td class="border-t border-gray-700 px-3 py-2"><button class="text-blue-400 hover:text-blue-300 underline" @click="selectRecord(r)">Edit</button></td>
                </tr>
              </template>
            </tbody>
          </table>
          <div class="flex items-center justify-between mt-4">
            <div class="flex items-center gap-3">
              <button class="px-3 py-2 rounded-md border border-gray-700 bg-gray-800 text-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                :disabled="currentPage <= 1 || loading"
                @click="prevPage">Prev</button>
              <div class="text-gray-300 text-sm">Page <span x-text="currentPage"></span> / <span x-text="totalPages"></span></div>
              <button class="px-3 py-2 rounded-md border border-gray-700 bg-gray-800 text-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                :disabled="currentPage >= totalPages || loading"
                @click="nextPage">Next</button>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-300">Per page</label>
              <select class="bg-gray-900 border border-gray-700 rounded-md px-2 py-1 text-gray-100"
                x-model.number="perPage"
                @change="currentPage=1; load()">
                <option :value="10">10</option>
                <option :value="20">20</option>
                <option :value="50">50</option>
                <option :value="100">100</option>
              </select>
              <div class="text-sm text-gray-400">Total: <span x-text="total"></span></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section x-show="page==='create'" class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
      <h2>Create Record</h2>
      <div class="row">
        <div>
          <label class="block text-sm font-medium">Artist<input class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" type="text" x-model="cr.artist"></label>
          <label class="block text-sm font-medium">Album<input class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" type="text" x-model="cr.album"></label>
          <label class="block text-sm font-medium">Price<input class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" type="number" x-model.number="cr.price"></label>
          <label class="block text-sm font-medium">Quantity<input class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" type="number" x-model.number="cr.qty"></label>
          <label>Format
            <select class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" x-model="cr.format">
              <option>Vinyl</option>
              <option>CD</option>
              <option>Cassette</option>
              <option>Digital</option>
            </select>
          </label>
          <label>Category
            <select class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" x-model="cr.category">
              <option>Rock</option>
              <option>Jazz</option>
              <option>Hip-Hop</option>
              <option>Classical</option>
              <option>Pop</option>
              <option>Alternative</option>
              <option>Indie</option>
            </select>
          </label>
          <label class="block text-sm font-medium">MBID<input class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" type="text" x-model="cr.mbid"></label>
          <button class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" @click="createRecord">Create</button>
          <div class="mt-2 text-sm" :class="createStatus.includes('Created') ? 'text-green-400' : (createStatus ? 'text-red-400' : 'text-gray-400')" x-text="createStatus || ''"></div>
        </div>
      </div>
    </section>

    <section x-show="page==='orders'" class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
      <h2>Orders</h2>
      <label class="block text-sm font-medium">Record
        <select class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" x-model="order.recordId">
          <template x-for="r in records" :key="r.id ">
            <option :value="r.id " x-text="r.artist + ' - ' + r.album"></option>
          </template>
        </select>
      </label>
      <label class="block text-sm font-medium">Quantity<input class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" type="number" x-model.number="order.quantity"></label>
      <button class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" @click="createOrder">Create Order</button>
      <div class="mt-2 text-sm" :class="orderStatus.includes('Order created') ? 'text-green-400' : (orderStatus ? 'text-red-400' : 'text-gray-400')" x-text="orderStatus || ''"></div>
    </section>

    <div x-cloak x-show="showEditModal" x-transition.opacity @keydown.escape.window="showEditModal=false" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click="showEditModal=false">
      <div class="bg-gray-800 border border-gray-700 text-gray-100 rounded-lg p-6 w-full max-w-lg shadow-xl" x-transition.scale @click.stop>
        <h3>Edit Record</h3>
        <label class="block text-sm font-medium">Id<input class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" type="text" x-model="er.id" disabled></label>
        <label class="block text-sm font-medium">Artist<input class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" type="text" x-model="er.artist"></label>
        <label class="block text-sm font-medium">Album<input class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" type="text" x-model="er.album"></label>
        <label class="block text-sm font-medium">Price<input class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" type="number" x-model.number="er.price"></label>
        <label class="block text-sm font-medium">Quantity<input class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" type="number" x-model.number="er.qty"></label>
        <label>Format
          <select class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" x-model="er.format">
            <option>Vinyl</option>
            <option>CD</option>
            <option>Cassette</option>
            <option>Digital</option>
          </select>
        </label>
        <label>Category
          <select class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" x-model="er.category">
            <option>Rock</option>
            <option>Jazz</option>
            <option>Hip-Hop</option>
            <option>Classical</option>
            <option>Pop</option>
            <option>Alternative</option>
            <option>Indie</option>
          </select>
        </label>
        <label class="block text-sm font-medium">MBID<input class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-gray-100" type="text" x-model="er.mbid"></label>
        <div class="row">
          <div>
            <button class="inline-flex items-center bg-gray-700 hover:bg-gray-600 text-gray-100 px-4 py-2 rounded" @click="showEditModal=false">Cancel</button>
            <button class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" :disabled="!er.id" @click="updateRecord">Update</button>
          </div>
        </div>
        <div class="mt-2 text-sm" :class="updateStatus.includes('Updated') ? 'text-green-400' : (updateStatus ? 'text-red-400' : 'text-gray-400')" x-text="updateStatus || ''"></div>
      </div>
    </div>
  </div>

  <script>
    function admin(){
      return {
        page: 'dashboard',
        showEditModal: false,
        records: [],
        loading: false,
        createStatus: '',
        updateStatus: '',
        orderStatus: '',
        lastLoaded: '',
        search: '',
        formatFilter: '',
        categoryFilter: '',
        sortParam: 'created',
        currentPage: 1,
        perPage: 20,
        total: 0,
        totalPages: 0,
        cr: { artist: '', album: '', price: '', qty: '', format: 'Vinyl', category: 'Rock', mbid: '' },
        er: { id: '', artist: '', album: '', price: '', qty: '', format: 'Vinyl', category: 'Rock', mbid: '' },
        order: { recordId: '', quantity: '' },
        async load(){
          try{
            this.loading = true;
            const params = new URLSearchParams();
            params.set('page', String(this.currentPage));
            params.set('pageSize', String(this.perPage));
            params.set('sort', this.sortParam || 'created');
            if(this.search) params.set('q', this.search);
            if(this.formatFilter) params.set('format', this.formatFilter);
            if(this.categoryFilter) params.set('category', this.categoryFilter);
            const r = await fetch('/records?' + params.toString());
            const json = await r.json();
            this.records = json.data || [];
            this.total = Number(json.total || 0);
            this.perPage = Number(json.perPage || this.perPage);
            this.currentPage = Number(json.page || this.currentPage);
            this.totalPages = Math.max(1, Math.ceil(this.total / this.perPage));
            this.lastLoaded = new Date().toLocaleString();
          }finally{
            this.loading = false;
          }
        },
        nextPage(){ if(this.currentPage < this.totalPages){ this.currentPage++; this.load(); } },
        prevPage(){ if(this.currentPage > 1){ this.currentPage--; this.load(); } },
        applyFilters(){ this.load(); },
        selectRecord(r){
          const id = r.id ;
          this.er = { id, artist: r.artist||'', album: r.album||'', price: r.price||'', qty: r.qty||'', format: r.format||'Vinyl', category: r.category||'Rock', mbid: r.mbid||'' };
          this.showEditModal = true;
        },
        async createRecord(){
          try{
            this.createStatus = 'Creating...';
            const res = await fetch('/records', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ artist: this.cr.artist, album: this.cr.album, price: Number(this.cr.price), qty: Number(this.cr.qty), format: this.cr.format, category: this.cr.category, mbid: this.cr.mbid || undefined }) });
            if(!res.ok){ throw new Error('Failed to create record'); }
            this.createStatus = 'Created';
            await this.load();
          }catch(e){ this.createStatus = e.message; }
        },
        async updateRecord(){
          try{
            this.updateStatus = 'Updating...';
            const id = this.er.id;
            const payload = { artist: this.er.artist || undefined, album: this.er.album || undefined, price: Number(this.er.price), qty: Number(this.er.qty), format: this.er.format || undefined, category: this.er.category || undefined, mbid: this.er.mbid || undefined };
            const res = await fetch('/records/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if(!res.ok){ throw new Error('Failed to update record'); }
            this.updateStatus = 'Updated';
            await this.load();
            this.showEditModal = false;
          }catch(e){ this.updateStatus = e.message; }
        },
        async createOrder(){
          try{
            this.orderStatus = 'Creating...';
            const res = await fetch('/orders', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ recordId: this.order.recordId, quantity: Number(this.order.quantity) }) });
            if(!res.ok){ throw new Error('Failed to create order'); }
            this.orderStatus = 'Order created';
          }catch(e){ this.orderStatus = e.message; }
        }
      }
    }
  </script>
</body>
</html>